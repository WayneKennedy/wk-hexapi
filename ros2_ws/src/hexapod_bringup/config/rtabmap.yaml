# RTAB-Map Configuration for Hexapod with D435i
# Visual SLAM using RGB-D camera

rtabmap:
  ros__parameters:
    # Frame configuration
    frame_id: "base_link"
    odom_frame_id: "odom"
    map_frame_id: "map"

    # Subscribe to these topics
    subscribe_depth: true
    subscribe_rgb: true
    subscribe_odom_info: false
    approx_sync: true
    queue_size: 10
    qos: 1

    # Topic remappings (set in launch file)
    # rgb/image: /camera/color/image_raw
    # depth/image: /camera/aligned_depth_to_color/image_raw
    # rgb/camera_info: /camera/color/camera_info

    # RTAB-Map database
    database_path: "~/.ros/rtabmap.db"

    # Detection
    Rtabmap/DetectionRate: "1.0"  # Hz

    # Memory management
    Mem/IncrementalMemory: "true"
    Mem/InitWMWithAllNodes: "false"

    # Odometry (use wheel odom, not visual odom)
    Odom/Strategy: "0"  # 0=Frame-to-Map

    # Loop closure
    Rtabmap/LoopThr: "0.11"
    Rtabmap/LoopRatio: "0.0"

    # Visual features
    Vis/MinInliers: "15"
    Vis/InlierDistance: "0.1"
    Vis/MaxFeatures: "400"

    # ICP (for depth alignment)
    Icp/VoxelSize: "0.05"
    Icp/MaxCorrespondenceDistance: "0.1"

    # Grid map generation
    Grid/CellSize: "0.05"
    Grid/RangeMin: "0.2"
    Grid/RangeMax: "3.0"
    Grid/RayTracing: "true"
    Grid/3D: "false"  # 2D occupancy grid for Nav2
    Grid/MaxGroundHeight: "0.05"
    Grid/MaxObstacleHeight: "1.0"
    Grid/NormalsSegmentation: "true"
    Grid/ClusterRadius: "0.1"
    Grid/MinClusterSize: "3"

    # Optimizer
    Optimizer/Strategy: "1"  # g2o
    Optimizer/Iterations: "20"

    # RGB-D specific
    RGBD/ProximityBySpace: "true"
    RGBD/ProximityMaxGraphDepth: "0"
    RGBD/ProximityPathMaxNeighbors: "1"
    RGBD/AngularUpdate: "0.1"  # radians
    RGBD/LinearUpdate: "0.1"   # meters
    RGBD/OptimizeFromGraphEnd: "false"
    RGBD/OptimizeMaxError: "3.0"

rtabmap_viz:
  ros__parameters:
    frame_id: "base_link"
    odom_frame_id: "odom"
    subscribe_depth: true
    subscribe_rgb: true
    approx_sync: true
